<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>chessboardjs Example #5000 - Only Allow Legal Moves</title>
  <base href="../" />
  <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU" crossorigin="anonymous">
</head>
<body>
<div id="myBoard" style="width: window.innerWidth"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js" integrity="sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUg3QbPyX8kWyb93+8AC/pPWTzj+nHtbC5bxD" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js" integrity="sha384-s3XgLpvmHyscVpijnseAmye819Ee3yaGa8NxstkJVyA6nuDFjt59u1QvuEl/mecz" crossorigin="anonymous"></script>
<script>
// --- Begin Example JS --------------------------------------------------------
myBoard = document.getElementById("myBoard");
myBoard.style["width"] = Math.min(window.innerWidth, window.innerHeight)
window.addEventListener("resize", resize);

function resize(){
	console.log("resize")
	var newWidth = Math.min(window.innerWidth, window.innerHeight)
	console.log(newWidth)
	myBoard.style["width"] = newWidth
	console.log(myBoard.style["width"])
}
	
const evtSource = new EventSource("state", {} );
	
evtSource.onmessage = (event) => {
	console.log(event)
	var data = JSON.parse(event.data)
	receiveGame(data.fen)
}

var whiteSquareGrey = '#a9a9a9'
var blackSquareGrey = '#696969'
var whiteSquareBlue = '#9c8dcf'
var blackSquareBlue = '#7f5f92'

function removeGreySquares () {
  $('#myBoard .square-55d63').css('background', '')
}

function greySquare (square) {
  var $square = $('#myBoard .square-' + square)
  var background = whiteSquareGrey
  if ($square.hasClass('black-3c85d')) {
    background = blackSquareGrey
  }
  $square.css('background', background)
}
	
function blueSquare (square) {
  var $square = $('#myBoard .square-' + square)

  var background = whiteSquareBlue
  if ($square.hasClass('black-3c85d')) {
    background = blackSquareBlue
  }

  $square.css('background', background)
}
	
var started = true
var colour = false
var player_id = String(Math.floor(Math.random() * (999999999999 - 100000000000) + 100000000000) )

var board = null
var game = new Chess()
var $status = $('#status')
var $fen = $('#fen')
var $pgn = $('#pgn')

function receiveGame(position, colour = false){
	game.load(position)
	colour = colour
	if (colour = 'white'){
		board.orientation('white')
	} else {
		board.orientation('black')
	}
	board.position(game.fen())
}

function sendMove(from, to){
	console.log('send move')
	var url = "move";
	var xhr = new XMLHttpRequest();
	xhr.open("POST", url, true);

	//Send the proper header information along with the request
	xhr.setRequestHeader("Content-type", "application/json");
	mov = from + to
	obj = {player_id: player_id, mov: mov}
	let data = JSON.stringify(obj);
	console.log(data)
	xhr.send(data);
}

function onDragStart (source, piece, position, orientation) {
  // do not pick up pieces if the game is over
  if (game.game_over()) return false

  // only pick up pieces for the side to move
  if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
      (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
    return false
  }

	var moves = game.moves({
    	square: source,
    	verbose: true
	})

	// exit if there are no moves available for this square
	if (moves.length === 0) return

	// highlight the possible squares for this piece
	for (var i = 0; i < moves.length; i++) {
		greySquare(moves[i].to)
	}
}

function onDrop (source, target) {
 	removeGreySquares()
	var moves = game.moves({ verbose: true })
	for (i in moves){
		var move = moves[i]
		if (move.from == source && move.to == target){
			sendMove(source, target)
			blueSquare(source)
			blueSquare(target)
		}
	}
	return 'snapback'
}

// update the board position after the piece snap
// for castling, en passant, pawn promotion
function onSnapEnd () {
  //board.position(game.fen())
	
}

function updateStatus () {
return(false)
  var status = ''

  var moveColor = 'White'
  if (game.turn() === 'b') {
    moveColor = 'Black'
  }

  // checkmate?
  if (game.in_checkmate()) {
    status = 'Game over, ' + moveColor + ' is in checkmate.'
  }

  // draw?
  else if (game.in_draw()) {
    status = 'Game over, drawn position'
  }

  // game still on
  else {
    status = moveColor + ' to move'

    // check?
    if (game.in_check()) {
      status += ', ' + moveColor + ' is in check'
    }
  }

  $status.html(status)
  $fen.html(game.fen())
  $pgn.html(game.pgn())
}

var config = {
	draggable: true,
	position: 'start',
	onDragStart: onDragStart,
	onDrop: onDrop,
	onSnapEnd: onSnapEnd,
	pieceTheme: 'static/themes/alpha/{piece}.png',
}
board = Chessboard('myBoard', config)

updateStatus()
// --- End Example JS ----------------------------------------------------------
</script>
</body>
</html>
